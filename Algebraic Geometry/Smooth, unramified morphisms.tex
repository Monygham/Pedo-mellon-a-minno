\input ../pree

\begin{document}

\title{Smooth, unramified and {\'e}tale morphisms}
\date{}
\maketitle

\section{Smooth morphisms}

\begin{definition}
Let $f:X\ra Y$ be a morphism of schemes and let $x$ be a point in $X$. Suppose that there is an open affine neighborhood $U$ of $x$ in $X$ and an open affine subscheme $V$ of $Y$ such that $f(U)\subseteq V$ and there is an open immersion
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=3em,text height=1.5ex, text depth=0.25ex] 
{ U   & \Spec \Gamma(V,\cO_Y)[x_1,...,x_{n+r}]/(f_1,...,f_r)\\};
\path[right hook->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$i $} (m-1-2);
\end{tikzpicture}
\end{center}
where $f_1,...,f_r \in \Gamma(V,\cO_Y)[x_1,...,x_{n+1}]$ are polynomials. In addition assume that \textit{the Jacobian matrix} 
$$ \frac{\partial(f_1,...,f_r)}{\partial(x_1,...,x_{n+r})} = \begin{pmatrix}
\frac{\partial f_1}{\partial x_1} & ... & \frac{\partial f_1}{\partial x_{n+r}} \\
... &...  &...  \\
\frac{\partial f_r}{\partial x_{1}} &...  & \frac{\partial f_r}{\partial x_{n+r}}\end{pmatrix}$$
of rank $r$ at $x$. Then we say that $f$ is \textit{smooth of relative dimension $n$ at $x$}.
\end{definition}

\begin{definition}
Let $f:X\ra Y$ be a morphism of schemes. For every $n\in \NN$ we define
$$\mathrm{SmoothLocus}_n(f) = \big\{x\in X\mid \mbox{$f$ is smooth of relative dimension $n$ at $x$ }\big\}$$
We also define
$$\mathrm{SmoothLocus}(f) = \bigcup_{n\in \NN}\mathrm{SmoothLocus}_n(f)$$
and call it \textit{the smooth locus of $f$}.
\end{definition}

\begin{theorem}\label{theorem:smoothness_implies_formal_smoothness}
Let $f:X\ra Y$ be a morphism of schemes smooth of relative dimension $n$ at some point $x$ of $X$. Then there exist open affine neighbourhoods $U$ of $x$ in $X$ and $V$ of $f(x)$ in $Y$ such that the following assertions hold.
\begin{enumerate}[label=\emph{\textbf{(\arabic*)}}, leftmargin=3.0em]
\item $f(U)$ is a subset of $V$.
\item The restriction of $f$ to the morphism $U\ra V$ is formally smooth and of finite presentation.
\item ${\Omega_{X/Y}}_{\mid U}$ is locally free of rank $n$.
\end{enumerate}
\end{theorem}
\begin{proof}
Assume that $f$ is smooth of relative dimension $n$ at $x$. By definition there exists an open affine neighborhood $W$ of $x$ and an open affine subset $V$ of $Y$ such that $f(W)\subseteq V$ and locally on $W$ the morphism $f$ factors as an open immersion
$$i:W \hookrightarrow \Spec \Gamma(V,\cO_Y)[x_1,...,x_{n+r}]/(f_1,...,f_r)$$
composed with the structural morphism
$$\Spec \Gamma(V,\cO_Y)[x_1,...,x_{n+r}]/(f_1,...,f_r)\ra V$$
in such a way that the Jacobian matrix
$$\begin{pmatrix}
\frac{\partial f_1}{\partial x_1} & ... & \frac{\partial f_1}{\partial x_{n+r}} \\
... &...  &...  \\
\frac{\partial f_r}{\partial x_{1}} &...  & \frac{\partial f_r}{\partial x_{n+r}}\end{pmatrix}$$
is of rank $r$ at $x$. Now suppose that $j_1$,...,$j_r$ are indices of columns of the Jacobian matrix evaluated at $x$ that are linearly independent over $k(x)$. Let
$$\delta=\mathrm{det}\bigg(\bigg[\frac{\partial f_i}{\partial x_{j_k}}\bigg]_{1\leq i\leq r,1\leq k\leq r}\bigg)\in \Gamma(V,\cO_Y)[x_1,...,x_{n+r}]$$
By assumption $\delta (x)\neq 0$ and hence there exists an open affine neighbourhood $U$ of $x$ in $W$ such that $\delta(z)\neq 0$ for every $z\in U$. Let $Q$ be an open subset of $\Spec \Gamma(V,\cO_Y)[x_1,...,x_{n+r}]$ contained in the nonvanishing set of $\delta$ such that $U = Q \cap \Spec \Gamma(V,\cO_Y)[x_1,...,x_{n+r}]/(f_1,...,f_r)$. Clearly $Q$ is formally smooth over $V$ and a morphism $j:U\hookrightarrow Q$ induced by $i$ is a closed immersion. We have the conormal sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ \cI/\cI^2       &j^*\Omega_{Q/V}& \Omega_{U/V}&0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$\sigma  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
of $j$. Here $\cI$ is a quasi-coherent ideal in $\cO_Q$ determining $j$. Now $j^*\Omega_{Q/V}$ is a locally free sheaf of $\cO_U$-modules with basis
$$j^*d({x_1}_{\mid Q}),\,....,\,j^*d({x_{n+r}}_{\mid Q})$$
and $\cI/\cI^2$ is a sheaf of $\cO_U$-modules generated by
$$j^*({f_1}_{\mid Q}),\,...,\,j^*({f_r}_{\mid Q})$$
Let $p: \cO^r_U \twoheadrightarrow \cI/\cI^2$ be the epimorphism of sheaves of $\cO_U$-modules determined by sections $j^*({f_1}_{\mid Q})$,...,$j^*({f_r}_{\mid Q})$ of $\cI/\cI^2$. The composition of $p$ with the morphism $\sigma: \cI/\cI^2\ra j^*\Omega_{Q/V}$ coming from the conormal sequence is given by the transpose of a matrix
$$\bd{J}= \bigg[j^*\bigg({\frac{\partial f_i}{\partial x_j}}_{\mid Q}\bigg)\bigg]_{1\leq i\leq r, 1\leq j\leq n+r}$$
Next we define a matrix $\bd{S}=[g_{ij}]_{1\leq i \leq r,1\leq j\leq n+r}$ of regular functions on $U$ as follows. We set $g_{ij}=0$ if $j \neq j_k$ for $k=1$,...,$r$ and we define the matrix $[g_{ij_k}]_{1\leq i\leq r,1\leq k\leq r}$ to be the inverse of the matrix
$$\bigg[j^*\bigg({\frac{\partial f_i}{\partial x_{j_k}}}_{\mid Q}\bigg)\bigg]_{1\leq k\leq r,1\leq i\leq r}$$
Such an inverse exists according to the fact that $j^*(\delta_{\mid Q})$ is invertible on $U$. Note that $\bd{S} \cdot \bd{J}^T$ is the $r\times r$ identity matrix. This implies that $\sigma\cdot p$ admits a section $s:j^*\Omega_{Q/V}\ra \cO^r_U$. In particular, $p$ is a monomorphism. Since it is an epimorphism, we derive that $p$ is an isomorphism and thus $\sigma$ is a monorphism having a section. Therefore, the conormal sequence for $j$ is split exact. Thus ${\Omega_{X/Y}}_{\mid U}=\Omega_{U/V}$ is free of rank $n$ and $U\ra V$ is formally smooth. Obviously $U\ra V$ is of finite presentation.
\end{proof}

\begin{proposition}\label{proposition:jacobian_criterion}
Let $A$ be a commutative ring. Suppose that $f_1,...,f_s\in A[x_1,...,x_m]$ are polynomials and $\ideal{q}$ is a prime ideal in $A[x_1,...,x_m]$ such that $f_1,...,f_s\in \ideal{q}$. Let $\ideal{p} = A\cap \ideal{q}$ be a prime ideal of $A$. Assume that the rank of the Jacobian matrix
$$\begin{pmatrix}
\frac{\partial f_1}{\partial x_1} & ... & \frac{\partial f_1}{\partial x_{m}} \\
... &...  &...  \\
\frac{\partial f_r}{\partial x_{1}} &...  & \frac{\partial f_r}{\partial x_{m}}\end{pmatrix}$$
is $r$ at $\ideal{q}$. Let $i_1,...,i_r$ be numbers of rows of that matrix that are linearly independent at $\ideal{q}$ and consider the surjective morphism
$$\pi:A[x_1,...,x_m]/(f_{i_1},...,f_{i_r}) \twoheadrightarrow A[x_1,...,x_m]/(f_1,...,f_s)$$
Then the following assertions hold.
\begin{enumerate}[label=\emph{\textbf{(\arabic*)}}, leftmargin=3.0em]
\item If $\Spec A[x_1,...,x_m]_{\ideal{q}}/(f_1,...,f_s)_{\ideal{q}} \ra \Spec A_{\ideal{p}}$ is formally smooth, then $\pi_{\ideal{q}}$ is an isomorphism.
\item If $\pi_{\ideal{q}}$ is an isomorphism, then $\Spec A[x_1,...,x_m]/(f_1,...,f_s)\ra \Spec A$ is smooth of relative dimension $m-r$ at $\ideal{q}$ reduced modulo $f_1,...,f_s$.
\end{enumerate}
\end{proposition}
\begin{proof}
For convenience in the proof we write $B = A[x_1,...,x_m]/(f_1,...,f_s),\,C = A[x_1,...,x_m]/(f_{i_1},...,f_{i_r}),\,\ideal{b}=(f_1,...,f_s),\,\ideal{c}=(f_{i_1},...,f_{i_r})$.\\
Assume that $A_{\ideal{p}}\ra B_{\ideal{q}}$ is formally smooth. Note that we have a commutative diagram
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ {\ideal{b}_{\ideal{q}}/\ideal{b}_{\ideal{q}}^2}       &B_{\ideal{q}}\otimes_{A[x_1,...,x_m]_{\ideal{q}}}\Omega_{ A[x_1,...,x_m]_{\ideal{q}} / A_{\ideal{p}}}& \Omega_{ B_{\ideal{q}}/A_{\ideal{p}}}&0 \\
 {\ideal{c}_{\ideal{q}}/\ideal{c}_{\ideal{q}}^2}       &C_{\ideal{q}}\otimes_{A[x_1,...,x_m]_{\ideal{q}}}\Omega_{ A[x_1,...,x_m]_{\ideal{q}} / A_{\ideal{p}}}& \Omega_{ C_{\ideal{q}}/A_{\ideal{p}}}&0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4)
(m-2-1) edge node[auto] {$  $} (m-2-2)
(m-2-2) edge node[auto] {$ $} (m-2-3)
(m-2-3) edge node[auto] {$ $} (m-2-4)
(m-2-1) edge node[auto] {$  $} (m-1-1)
(m-2-2) edge node[auto] {$ $} (m-1-2)
(m-2-3) edge node[auto] {$ $} (m-1-3);
\end{tikzpicture}
\end{center}
in which rows are conormal sequences of $A[x_1,...,x_m]_{\ideal{q}}\twoheadrightarrow B_{\ideal{q}}$ and $A[x_1,...,x_m]_{\ideal{q}}\twoheadrightarrow C_{\ideal{q}}$. Observe that the bottom row is split exact as $\Spec C\ra \Spec A$ is smooth of relative dimension $m-r$ at $\ideal{q}$. Similarly by formal smoothness of $A_{\ideal{p}} \ra B_{\ideal{q}}$ the top row is split exact. Hence after tensoring with $k(\ideal{q})$ we get a commutative diagram with exact rows
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{0& k(\ideal{q})\otimes_{A[x_1,...,x_m]_{\ideal{q}}}{\ideal{b}_{\ideal{q}}/\ideal{b}_{\ideal{q}}^2}       &k(\ideal{q})\otimes_{A[x_1,...,x_m]_{\ideal{q}}}\Omega_{ A[x_1,...,x_m]_{\ideal{q}} / A_{\ideal{p}}}& k(\ideal{q})\otimes_{B_{\ideal{q}}}\Omega_{ B_{\ideal{q}}/A_{\ideal{p}}}&0 \\
0& k(\ideal{q})\otimes_{A[x_1,...,x_m]_{\ideal{q}}}{\ideal{c}_{\ideal{q}}/\ideal{c}_{\ideal{q}}^2}       &k(\ideal{q})\otimes_{A[x_1,...,x_m]_{\ideal{q}}}\Omega_{ A[x_1,...,x_m]_{\ideal{q}} / A_{\ideal{p}}}& k(\ideal{q})\otimes_{C_{\ideal{q}}}\Omega_{C_{\ideal{q}}/A_{\ideal{p}}}&0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4)
(m-1-4) edge node[auto] {$ $} (m-1-5)
(m-2-1) edge node[auto] {$  $} (m-2-2)
(m-2-2) edge node[auto] {$ $} (m-2-3)
(m-2-3) edge node[auto] {$ $} (m-2-4)
(m-2-4) edge node[auto] {$ $} (m-2-5)
(m-2-4) edge node[auto] {$  $} (m-1-4)
(m-2-2) edge node[auto] {$ $} (m-1-2)
(m-2-3) edge node[auto] {$= $} (m-1-3);
\end{tikzpicture}
\end{center}
According to the choice of $f_{i_1},...,f_{i_r}$, we derive that
$$\mathrm{dim}_{k(\ideal{q})}\big(k(\ideal{q})\otimes_{B_{\ideal{q}}}\Omega_{B_\ideal{q}/A_{\ideal{p}}}\big) = m - r = \mathrm{dim}_{k(\ideal{q})}\big(k(\ideal{q})\otimes_{C_{\ideal{q}}}\Omega_{C_{\ideal{q}}/A_{\ideal{p}}}\big)$$
In particular, the rightmost vertical morphism in the diagram is an epimorphism of vector spaces over $k(\ideal{q})$ of the same finite dimension. Thus it is an isomorphism. This implies that the leftmost morphism in the diagram is an isomorphism. Thus by virtue of Nakayama lemma $\ideal{c}_{\ideal{q}}/\ideal{c}^2_{\ideal{q}}\ra \ideal{b}_{\ideal{q}}/\ideal{b}^2_{\ideal{q}}$ is an epimorphism. Using Nakayama lemma once more we deduce that $\ideal{c}_{\ideal{q}} \hookrightarrow \ideal{b}_{\ideal{q}}$ is an epimorphism and thus $\ideal{c}_{\ideal{q}} = \ideal{b}_{\ideal{q}}$. Hence $\pi_{\ideal{q}}$ is an isomorphism and the proof of \textbf{(1)} is completed.\\
On the other hand if $\pi_{\ideal{q}}$ is an isomorphism, then $\Ker(\pi)$ is a finitely generated ideal in $C$ that vanishes at $\ideal{q}$ modulo $f_{i_1},...,f_{i_r}$. Hence it vanishes on some open neighborhood of $\ideal{q}$ modulo $f_{i_1},...,f_{i_r}$ in $\Spec C$ and thus $\Spec \pi$ is an isomorphism on that neighborhood. Thus $\Spec B\ra \Spec A$ is smooth of relative dimension $m-r$ at $\ideal{q}$ reduced modulo $f_1,...,f_s$ and \textbf{(2)} is proved.
\end{proof}

\begin{corollary}\label{corollary:characterization_of_smoothness_in_terms_of_formal_smoothness_and_locally_finite_presentation}
Let $f:X\ra Y$ be a morphism of schemes and let $x$ be a point in $X$. Then the following conditions are equivalent.
\begin{enumerate}[label=\emph{\textbf{(\roman*)}}, leftmargin=3.0em]
\item $f$ is smooth at $x$.
\item There exists an open neighborhood $U$ of $x$ in $X$ such that $f_{\mid U}$ is formally smooth and locally of finite presentation
\item There exists an open neighborhood $U$ of $x$ in $X$ such that $f_{\mid U}$ is locally of finite presentation and the local morphism $f^{\#}:\cO_{Y,f(x)}\ra \cO_{X,x}$ is formally smooth.
\end{enumerate}
\end{corollary}
\begin{proof}
The implication $\textbf{(i)}\Rightarrow \textbf{(ii)}$ follows from Theorem \ref{theorem:smoothness_implies_formal_smoothness}.\\
Suppose that \textbf{(ii)} holds. We want to prove \textbf{(iii)}. Since this is a local assertion, we may assume that there exists a closed immersion $i:U\ra \mathbb{A}^m_Y$. Let $\cI$ be a quasi-coherent ideal determining $i$. Then the conormal sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ \cI/\cI^2       &i^*\Omega_{\mathbb{A}^m_Y/Y}& \Omega_{U/Y}&0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
is locally split exact. Thus after localizing at $x$ we derive a split exact sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ \cI_x/\cI_x^2 &\cO_{X,x}\otimes_{\cO_{\mathbb{A}^m_Y ,i(x)}}\Omega_{\cO_{\mathbb{A}^m_Y,i(x)} / \cO_{Y,f(x)}} & \Omega_{ \cO_{X,x}/\cO_{Y,f(x)}} & 0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
which implies that $f^{\#}:\cO_{Y,f(x)}\ra \cO_{X,x}$ is formally smooth.\\
Finally $\textbf{(iii)}\Rightarrow \textbf{(i)}$ is an easy consequence of Proposition \ref{proposition:jacobian_criterion}.
\end{proof}

\begin{corollary}\label{corollary:smooth_locuses_are_open}
Let $f:X\ra Y$ be a morphism of schemes and let $n\in \NN$ be a natural number. Then $\mathrm{SmoothLocus}_n(f)$ is open subset of $X$ and the sheaf $\Omega_{X/Y}$ is locally free of rank $n$ on $\mathrm{SmoothLocus}_n(f)$.
\end{corollary}
\begin{proof}
It follows from Corollary \ref{corollary:characterization_of_smoothness_in_terms_of_formal_smoothness_and_locally_finite_presentation} that $\mathrm{SmoothLocus}(f)$ is open subset of $X$. From Theorem \ref{theorem:smoothness_implies_formal_smoothness} we derive that ${\Omega_{X/Y}}_{\mid \mathrm{SmoothLocus}(f)}$ is locally free of finite rank and $$\mathrm{SmoothLocus}_n(f) = \big\{x\in \mathrm{SmoothLocus}(f)\,\big|\,\mathrm{rank}\left({\Omega_{X/Y}}_x\right)=n\, \big\}$$
Thus $\mathrm{SmoothLocus}_n(f)$ is open subset of $X$ and $\Omega_{X/Y}$ is locally free of rank $n$ on $\mathrm{SmoothLocus}_n(f)$.
\end{proof}

\begin{proposition}\label{proposition:smooth_morphisms_are_closed_under_base_change_and_composition}
The following assertions hold.
\begin{enumerate}[label=\emph{\textbf{(\arabic*)}}, leftmargin=3.0em]
\item Let $f:X\ra Y$ and $g:Y'\ra Y$ be morphisms of schemes. Consider the cartesian square
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=2em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ X' &    X                           \\
   Y' &   Y                 \\} ;
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$ g'$} (m-1-2)
(m-2-1) edge node[below] {$ g$} (m-2-2)
(m-1-1) edge node[left] {$f' $} (m-2-1)
(m-1-2) edge node[auto] {$ f$} (m-2-2);
\end{tikzpicture}
\end{center} 
If $f$ is smooth of relative dimension $n$ at $x\in X$ and $x'\in X'$ is a point such that $g'(x')=x$, then $f'$ is smooth of relative dimension $n$ at $x'$.
\item Let $f:X\ra Y$ and $g:Y\ra Z$ be morphisms of schemes. If $f$ is smooth of relative dimension $n$ at $x\in X$ and $g$ is smooth of relative dimension $m$ at $f(x)$, then $g\cdot f$ is smooth of relative dimension $n+m$ at $x$.
\end{enumerate}
\end{proposition}
\begin{proof}
Observe that classes of formally smooth and locally of finite presentation morphisms are closed under base change and composition. Therefore, by Corollary \ref{corollary:characterization_of_smoothness_in_terms_of_formal_smoothness_and_locally_finite_presentation} in order to prove assertions it is enough to check relative dimensions. For this we use Corollary \ref{corollary:smooth_locuses_are_open} and compute ranks of sheaves of differentials. In case \textbf{(1)} observe that $g'^*\Omega_{X/Y}\cong \Omega_{X'/Y'}$ and hence if $\Omega_{X/Y}$ has rank $n$ at point $x$, then $\Omega_{X'/Y'}$ has rank $n$ at $x'$. For \textbf{(2)} consider an exact sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ f^*\Omega_{Y/Z}       &\Omega_{X/Z}& \Omega_{X/Y}&          0             \\} ;
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
which splits locally in neighborhood of $x$. Since $f^*\Omega_{Y/Z}$ has rank $m$ at $x$ and $\Omega_{X/Y}$ has rank $n$ at $x$, we derive that $\Omega_{X/Z}$ has rank $n+m$ at $x$.
\end{proof}

\begin{theorem}\label{theorem:faithfuly_flat_descent_for_smooth_morphisms}
Let $f:X\ra Y$ be a morphism locally of finite presentation. Suppose that $g:Y'\ra Y$ is a morphism of schemes. Assume that $g$ is flat at some point $y'$ of $Y'$. Consider the cartesian diagram
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=2em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ X' &    X                           \\
   Y' &   Y                 \\} ;
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$ g'$} (m-1-2)
(m-2-1) edge node[below] {$ g$} (m-2-2)
(m-1-1) edge node[left] {$f' $} (m-2-1)
(m-1-2) edge node[auto] {$ f$} (m-2-2);
\end{tikzpicture}
\end{center} 
Let $x$ be a point of $X$ and $x'$ be a point of $X'$ lying over $x$. Then the following assertions are equivalent.
\begin{enumerate}[label=\emph{\textbf{(\roman*)}}, leftmargin=3.0em]
\item $f$ is smooth at $x$.
\item $f'$ is smooth at $x'$.
\end{enumerate}
\end{theorem}
\begin{proof}
By Proposition \ref{proposition:smooth_morphisms_are_closed_under_base_change_and_composition} it suffices to prove $\textbf{(ii)} \Rightarrow \textbf{(i)}$. Let $y = f(x)$. Clearly both $f$ and $f'$ are locally of finite presentation. The question is local so we may assume that schemes $X$, $Y$, $Y'$ are affine. Consider closed immersion $i:X\hookrightarrow \mathbb{A}^{m}_Y$ determined by the ideal $\cI$. Let $i':X'\hookrightarrow \mathbb{A}^m_{Y'}$ be the base change of $i$ along $g:Y'\ra Y$ and denote its ideal by $\cI'$. Then the conormal sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ (\cI'/\cI'^2)_{x'}       &(i'^*\Omega_{ \mathbb{A}^m_{Y'} / Y'})_{x'}& (\Omega_{ X'/Y'})_{x'}&0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
of $i'$ at $x'$ is a split short exact sequence. Since it is canonically isomorphic to the sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ \cO_{X',x'}\otimes_{\cO_{X,x}}(\cI/\cI^2)_x & \cO_{X',x'}\otimes_{\cO_{X,x}}(i^*\Omega_{ \mathbb{A}^m_Y / Y})_x & \cO_{X',x'}\otimes_{\cO_{X,x}}(\Omega_{ X/Y})_x & 0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
i.e the conormal sequence for $i$ at $x$ tensored with $
\cO_{X',x'}$ over $\cO_{X,x}$. We utilize the assumption that $\cO_{X,x} \ra \cO_{X',x'}$ is faithfully flat to deduce that the conormal sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{(\cI/\cI^2)_x      &(i^*\Omega_{ \mathbb{A}^m_Y / Y})_x& (\Omega_{ X/Y})_x&0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
is short exact and $\cO_{X,x}$-module $(\Omega_{X/Y})_x$ is flat. Since $(\Omega_{X/Y})_x$ is finitely presented, we derive that it is free and hence the conormal sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{(\cI/\cI^2)_x      &(i^*\Omega_{ \mathbb{A}^m_Y / Y})_x& (\Omega_{ X/Y})_x&0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
is a split short exact sequence. Therefore, $f^{\#}:\cO_{Y,y}\ra \cO_{X,x}$ is formally smooth and, since $f$ is locally of finite presentation, we derive by Corollary \ref{corollary:characterization_of_smoothness_in_terms_of_formal_smoothness_and_locally_finite_presentation} that $f$ is smooth at $x$.
\end{proof}

\section{Smoothness for schemes over a field}
\noindent
In this section we use the following notation. Let $X$ be a scheme over a field $k$. For every field extension $K$ of $k$ we denote by $X_K$ the $K$-scheme $\Spec K \times_{\Spec k}X$.

\begin{definition}
Let $X$ be a scheme over a field $k$ and let $x$ be a point of $X$. Then $X$ is \textit{geometrically regular at $x$} if for every field extension $K$ of $k$ and every point $\ol{x}$ in $X_K$ lying over $x$ the scheme $X_K$ is regular at $\ol{x}$.
\end{definition}

\begin{theorem}\label{theorem:main_result_concerning_smoothness_over_a_field}
Let $X$ be a scheme locally of finite type over a field $k$ and let $x$ be a point of $X$. Then the inequality
$$\mathrm{dim}_x(X)\leq \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/k}\big)$$
holds and the following assertions are equivalent.
\begin{enumerate}[label=\emph{\textbf{(\roman*)}}, leftmargin=3.0em]
\item $X$ is smooth at $x$.
\item $X$ is geometrically regular over $k$ at $x$.
\item For some perfect extension $K$ of $k$ and some point $\ol{x}\in X_K$ lying over $x$ the local ring $\cO_{X_K,\ol{x}}$ is regular.
\item $\mathrm{dim}_x(X) = \mathrm{dim}_{k(x)}(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/k})$ 
\end{enumerate}
\end{theorem}
\noindent
We prove the theorem in a series of lemmas.

\begin{lemma}\label{lemma:inequality_of_dimensions}
Let $K$ be a perfect field and let $X$ be a scheme locally of finite type over $K$. Suppose that $x$ is a point $X$. Then
$$\mathrm{dim}_x(X) \leq \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/K}\big)$$
and the equality holds if and only if $\cO_{X,x}$ is regular.
\end{lemma}
\begin{proof}[Proof of the lemma]
Consider the conormal sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{\ideal{m}_{x}/\ideal{m}_{x}^2       &k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/k}& \Omega_{k(x)/K}&          0             \\} ;
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4);
\end{tikzpicture}
\end{center}
of the closed immersion $\Spec k(x) \hookrightarrow \Spec \cO_{X,x}$ of $K$-schemes. Since $k(x)$ is formally smooth over $K$ by {\cite[Corollary 6.4]{Formally_smooth_and_unramified}} and $K$ is perfect, we derive that the sequence above is short exact. Hence
$$\mathrm{dim}_x(X) = \mathrm{dim}\big(\cO_{X,x}\big) + \mathrm{tr}_K\big(k(x)\big) \leq \mathrm{dim}_{k(x)}\big(\ideal{m}_x/\ideal{m}^2_x\big) + \mathrm{tr}_K\big(k(x)\big) =$$
$$= \mathrm{dim}_{k(x)}\big(\ideal{m}_x/\ideal{m}^2_x\big) + \mathrm{dim}_{k(x)}\big(\Omega_{k(x)/K}\big) = \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/K}\big)$$
and the equality holds if and only if $\mathrm{dim}\big(\cO_{X,x}\big) = \mathrm{dim}_{k(x)}\big(\ideal{m}_x/\ideal{m}^2_x\big)$. This equality is equivalent to regularity of $\cO_{X,x}$.
\end{proof}

\begin{lemma}\label{lemma:for_perfect_fields_regular_implies_smooth}
Let $K$ be a perfect field and let $X$ be a scheme locally of finite type over $K$. Suppose that $x$ is a point $X$. If $\cO_{X,x}$ is regular, then $X$ is smooth at $x$.
\end{lemma}
\begin{proof}[Proof of the lemma]
Since the assertions are local we may assume that there exists a closed immersion $i:X\ra \mathbb{A}^m_K$ given by a quasi-coherent ideal $\cI$ generated by polynomials $f_1,...,f_s\in K[x_1,...,x_m]$. Next suppose that the Jacobian matrix
$$\left( \begin{array}{ccc}
\frac{\partial f_1}{\partial x_1} & ... & \frac{\partial f_1}{\partial x_{m}} \\
... &...  &...  \\
\frac{\partial f_s}{\partial x_{1}} &...  & \frac{\partial f_s}{\partial x_{m}}\end{array} \right)$$
is of rank $r$ at $x$. Assume that $i_1$,...,$i_r$ are numbers of rows that are linearly independent over $k(x)$. Let $j:Z\hookrightarrow \mathbb{A}^m_K$ be a closed subscheme of $\mathbb{A}^m_K$ determined by the ideal $\cJ$ generated by $f_{i_1}$,...,$f_{i_r}$. Then there exists a closed immersion $u:X\hookrightarrow Z$ such that $i\cdot u = j$. Consider a commutative diagram
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{ \big(u^*\left(\cJ/\cJ^2\right)\big)_x & (u^*j^*\Omega_{\mathbb{A}^m_K / K})_x & (u^*\Omega_{Z / K})_x & 0 \\
  (\cI/\cI^2)_x & (i^*\Omega_{\mathbb{A}^m_K / K})_x & (\Omega_{X/K})_x & 0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$ $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4)
(m-2-1) edge node[auto] {$ $} (m-2-2)
(m-2-2) edge node[auto] {$ $} (m-2-3)
(m-2-3) edge node[auto] {$ $} (m-2-4)

(m-1-1) edge node[auto] {$ $} (m-2-1)
(m-1-2) edge node[auto] {$ = $} (m-2-2)
(m-1-3) edge node[auto] {$ $} (m-2-3);
\end{tikzpicture}
\end{center}
In the diagram rows are induced by conormal sequences for $j$ and $i$. The leftmost vetical arrow is induced by the inclusion $\cJ\hookrightarrow \cI$ and the rightmost vertical arrow is induced by the cotangent morphism $u^*\Omega_{Z/K}\ra \Omega_{X/K}$. It follows from the choice of $i_1,...,i_r$ that morphisms
$$\big(u^*\left(\cJ/\cJ^2\right)\big)_x \ra (u^*j^*\Omega_{\mathbb{A}^m_K / K})_x,\,(\cI/\cI^2)_x \ra (i^*\Omega_{\mathbb{A}^m_K / K})_x$$
have the same image in $(u^*j^*\Omega_{\mathbb{A}^m_K / K})_x = (i^*\Omega_{\mathbb{A}^m_K / K})_x$. Thus the morphism $\left(u^*\Omega_{Z/K}\right)_x \ra \left(\Omega_{X/K}\right)_x$ induced by the cotangent morphism of $u$ is an isomorphism. This implies that
$$\mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{Z,x}}\Omega_{\cO_{Z,x}/K}\big) = \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/K}\big)$$
By definition $Z$ is smooth at $x$. Hence by {\cite[Theorem 6.3]{Formally_smooth_and_unramified}} and Corollary \ref{corollary:characterization_of_smoothness_in_terms_of_formal_smoothness_and_locally_finite_presentation} we deduce that $Z$ is regular at $x$. By assumption $X$ is regular at $x$. Thus by Lemma \ref{lemma:inequality_of_dimensions} we derive that
$$\mathrm{dim}_x(Z) = \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{Z,x}}\Omega_{\cO_{Z,x}/K}\big) = \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/K}\big) = \mathrm{dim}_x(X)$$
Hence
$$\mathrm{tr}_{K}(k(x)) + \mathrm{dim}\big(\cO_{Z,x}\big) = \mathrm{dim}_x(Z) = \mathrm{dim}_x(X) = \mathrm{tr}_{K}(k(x)) + \mathrm{dim}\big(\cO_{X,x}\big)$$
We conclude that $\mathrm{dim}\big(\cO_{Z,x}\big) = \mathrm{dim}\big(\cO_{X,x}\big)$. This implies that $u^{\#}:\cO_{Z,x}\twoheadrightarrow \cO_{X,x}$ is a surjective morphism of regular rings of the same dimension. Hence it is an isomorphism. By Proposition \ref{proposition:jacobian_criterion} we deduce that $X$ is smooth at $x$.
\end{proof}

\begin{proof}[Proof of the theorem]
The implication $\textbf{(i)}\Rightarrow \textbf{(ii)}$ follows from the fact that smoothness is closed under base change (Proposition \ref{proposition:smooth_morphisms_are_closed_under_base_change_and_composition}), the fact that smoothness implies formal smoothness (Corollary \ref{corollary:characterization_of_smoothness_in_terms_of_formal_smoothness_and_locally_finite_presentation}) and {\cite[Theorem 6.3]{Formally_smooth_and_unramified}}, which states that formally smooth noetherian local $k$-algebras are regular. The implication $\textbf{(ii)}\Rightarrow \textbf{(iii)}$ is obvious. Suppose now that \textbf{(iii)} holds. Then Lemma \ref{lemma:for_perfect_fields_regular_implies_smooth} implies that $X_K$ is smooth at $\ol{x}$. By Theorem \ref{theorem:faithfuly_flat_descent_for_smooth_morphisms} we deduce that $X$ is smooth at $x$. Hence also $\textbf{(iii)}\Rightarrow \textbf{(i)}$. This completes the proof that \textbf{(i)}, \textbf{(ii)}, \textbf{(iii)} are equivalent.\\
Now we prove the inequality
$$\mathrm{dim}_x(X) \leq \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/K}\big)$$
and the fact that \textbf{(iv)} is equivalent with \textbf{(i)}, \textbf{(ii)}, \textbf{(iii)}. Suppose that $\mathrm{char}(k) = p$. If $p>0$, then consider $K = k^{\frac{1}{p^{\infty}}}$ i.e. the perfect closure of $k$. If $p = 0$, then pick $K = k$. Let $\pi:X_K\ra X$ be the canonical projection. The morphism $\Spec K \ra \Spec k$ is surjective, universally injective and integral. Since $\pi$ is a base change of $\Spec K\ra \Spec k$, we derive that $\pi$ is also surjective, universally injective and integral. Hence $\pi$ is a homeomorphism. Thus there exists a unique point $\ol{x}$ in $X_K$ lying over $x$ and
$$\mathrm{dim}_{\ol{x}}\big(X_K\big) = \mathrm{dim}_x(X)$$
Moreover, we have
$$k(\ol{x})\otimes_{\cO_{X_K,\ol{x}}}\Omega_{\cO_{X_K,\ol{x}}/K} \cong k(\ol{x})\otimes_{\cO_{X_K,\ol{x}}}\big(\Omega_{X_K/K}\big)_{\ol{x}} \cong k(\ol{x})\otimes_{\cO_{X_K,\ol{x}}}\big(\pi^*\Omega_{X/k}\big)_{\ol{x}} \cong$$
$$\cong k(\ol{x})\otimes_{\cO_{X_K,\ol{x}}} \cO_{X_K,\ol{x}}\otimes_{\cO_{X,x}}\big(\Omega_{X/k}\big)_x = k(\ol{x})\otimes_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/k}\big)$$
Thus
$$\mathrm{dim}_{k(\ol{x})}\big(k(\ol{x})\otimes_{\cO_{X_K,\ol{x}}}\Omega_{\cO_{X_K,\ol{x}}/K}\big) = \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/k}\big)$$
Now according to Lemma \ref{lemma:inequality_of_dimensions} we have
$$ \mathrm{dim}_x(X) = \mathrm{dim}_{\ol{x}}\big(X_K\big) \leq \mathrm{dim}_{k(\ol{x})}\big(k(\ol{x})\otimes_{\cO_{X_K,\ol{x}}}\Omega_{\cO_{X_K,\ol{x}}/K}\big) = \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/k}\big)$$
and the equality holds if and only if $\cO_{X_K,\ol{x}}$ is regular. Thus by Lemma \ref{lemma:for_perfect_fields_regular_implies_smooth} the equality holds if and only if $X_K$ is smooth at $\ol{x}$, but this according to  Proposition \ref{proposition:smooth_morphisms_are_closed_under_base_change_and_composition} and Theorem \ref{theorem:faithfuly_flat_descent_for_smooth_morphisms} is equivalent with smoothness of $X$ at $x$. The proof is complete.
\end{proof}

\begin{corollary}\label{corollary:relative_smooth_dimension_is_local_dimension}
Let $X$ be a scheme locally of finite type over a field $k$. Suppose that $X$ is smooth of relative dimension $n$ at some point $x$. Then $\mathrm{dim}_x(X)=n$.
\end{corollary}
\begin{proof}
According to Corollary \ref{corollary:smooth_locuses_are_open} and Theorem \ref{theorem:main_result_concerning_smoothness_over_a_field} we have
$$n = \mathrm{dim}_{k(x)}\big(k(x)\otimes_{\cO_{X,x}}\Omega_{\cO_{X,x}/k}\big) = \mathrm{dim}_x(X)$$
\end{proof}

\section{Smooth morphisms are flat families of smooth schemes over fields}

\begin{theorem}\label{theorem:smooth_is_flat_with_smooth_fibers}
Let $f:X\ra Y$ be a morphism of schemes and let $x$ be a point in $X$. Suppose that there exists a neighborhood $U$ of $x$ such that $f_{\mid U}$ is locally of finite presentation. Then the following assertions are equivalent.
\begin{enumerate}[label=\emph{\textbf{(\roman*)}}, leftmargin=3.0em]
\item $f$ is smooth at $x$.
\item $f$ is flat at $x$ and the fiber $X_{f(x)}$ is smooth at $x$.
\end{enumerate}
\end{theorem}
\begin{proof}
We will prove that $\textbf{(i)}\Rightarrow \textbf{(ii)}$. Since smoothness is stable under base change, we derive that fiber of $X_{f(x)}$ is smooth. It suffices to prove that $f$ is flat at $x$. This question is local on base and domain. Hence we may assume that $Y$ is affine and $X$ is a closed subscheme of $\mathbb{A}^{n+r}_Y$ determined by ideal generated by polynomials $f_1,...,f_r\in \Gamma(Y,\cO_Y)[x_1,...,x_{n+r}]$ such that the Jacobian matrix
$$\left( \begin{array}{ccc}
\frac{\partial f_1}{\partial x_1} & ... & \frac{\partial f_1}{\partial x_{n+r}} \\
... &...  &...  \\
\frac{\partial f_r}{\partial x_{1}} &...  & \frac{\partial f_r}{\partial x_{n+r}}\end{array} \right)$$
of rank $r$ at $x$. Consider the set of all nonzero coefficients of polynomials $f_1,...,f_r$ and define $A \subseteq \Gamma(Y,\cO_Y)$ as the $\ZZ$-subalgebra generated by all these coefficients. We define $Y = \Spec A$. Note that polynomials $f_1,...,f_r$ have coefficients in $A$ and hence we can define $X_0$ as a closed subscheme of $\mathbb{A}^{n+r}_{Y_0}$ determined by the ideal generated by $f_1,...,f_r$. We have cartesian square
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=3em,text height=1.5ex, text depth=0.25ex] 
{  X & X_0 \\
   Y & Y_0 \\} ;
\path[->,line width=1.0pt,font=\scriptsize]
(m-1-1) edge node[auto] {$ g' $} (m-1-2)
(m-2-1) edge node[below] {$ g $} (m-2-2)
(m-1-1) edge node[left] {$ f $} (m-2-1)
(m-1-2) edge node[right] {$ f_0 $} (m-2-2);
\end{tikzpicture}
\end{center}
where $f_0:X_0\ra Y_0$ is the canonical morphism. Next we define $x_0 = g'(x)$ in $X_0$. It is straightforward to verify that rank of the matrix
\begin{center}
\[ \frac{\partial(f_1,...,f_r)}{\partial(x_1,...,x_{n+r})}= \left( \begin{array}{ccc}
\frac{\partial f_1}{\partial x_1} & ... & \frac{\partial f_1}{\partial x_{n+r}} \\
... &...  &...  \\
\frac{\partial f_r}{\partial x_{1}} &...  & \frac{\partial f_r}{\partial x_{n+r}}\end{array} \right)\]
\end{center}
in $x_0$ is the same as its rank in $x$. Hence $f_0$ is smooth at $x_0$. It suffices to prove that $f_0$ is flat at $x_0$. Note that $Y_0$ is noetherian. Therefore, without loss of generality we may assume that $Y$ is noetherian. Let $f(x) = y$ and $h:\mathbb{A}^{n+r}_{k(y)} \hookrightarrow \mathbb{A}^{n+r}_Y$ be the canonical monomorphism. Let $\ol{x} = h(x)$ and $\ol{f}_1=h^{\#}(f_1)$,...,$\ol{f}_r=h^{\#}(f_r)$. Note that the closed subscheme $V(f_1,...,f_i)$ of $\mathbb{A}^{n+r}_Y$ determined by the ideal generated by $f_1,...,f_i$ is smooth of relative dimension $n+r-i$ at $x$ and consequently the closed subscheme $V(\ol{f}_1,...,\ol{f}_i)$ of $\mathbb{A}^{n+r}_{k(y)}$ determined by the ideal generated by $\ol{f}_1,...,\ol{f}_i$ is smooth of relative dimension $n+r-i$ at $\ol{x}$. According to Theorem \ref{theorem:main_result_concerning_smoothness_over_a_field} local ring $\cO_{V(\ol{f}_1,...,\ol{f}_i),\ol{x}}$ is regular. This shows that $\ol{f}_1$,...,$\ol{f}_r$ is a regular sequence in $\cO_{\mathbb{A}^{n+r}_{k(y)},\ol{x}}$. Define finitely generated $\cO_{\mathbb{A}^{n+r}_{Y},x}$-modules
$$C_i=\begin{cases} 
\cO_{\mathbb{A}^{n+r}_{Y},x} &\mbox{if } i=0\\
\cO_{V(f_1,...,f_i),x} &\mbox{if } i>0
\end{cases}$$
for $0\leq i\leq r$. Then $C_0$ is flat $\cO_{\mathbb{A}^{n+r}_{Y},x}$-module and for every $0\leq i\leq r-1$ multiplication by the germ of $f_{i+1}$ on $C_i$ is a monomorphism after reduction to $k(x)$. By {\cite[Corollary 3.5]{Flatnessingeometry}} if $M$, $N$ are finitely generated $\cO_{\mathbb{A}^{n+r}_{Y},x}$-modules, $N$ is a flat $\cO_{\mathbb{A}^{n+r}_{Y},x}$-module and $\phi:M\ra N$ is $\cO_{\mathbb{A}^{n+r}_{Y},x}$-module morphism such that $\phi\otimes_{\cO_{\mathbb{A}^{n+r}_{Y},x}}1_{k(x)}$ is a monomorphism, then $\phi$ is a monomorphism and $N/\phi(M)$ is flat $\cO_{\mathbb{A}^{n+r}_{Y},x}$-module. Applying this fact we deduce that $C_i$ are flat $\cO_{\mathbb{A}^{n+r}_{Y},x}$-modules for $0\leq i\leq r$ and the germ of $f_{i+1}$ is a nonzero divisor in $C_i$ for $0\leq i\leq r-1$. In particular, $C_r = \cO_{X,x}$ is a flat $\cO_{\mathbb{A}^{n+r}_{Y},x}$-module. Thus $f$ is flat at $x$. \\
Now we prove that $\textbf{(ii)}\Rightarrow \textbf{(i)}$. We assume \textbf{(ii)} and want to deduce \textbf{(i)}. Again the question is local both on target and domain.  As above we may assume that $Y$ is affine and $X$ is a closed subscheme of $\mathbb{A}^{m}_Y$ determined by ideal generated by polynomials $f_1,...,f_s\in \Gamma(Y,\cO_Y)[x_1,...,x_{m}]$. Denote $y = f(x)$. Next let $r$ be the rank of the Jacobian matrix
$$\left( \begin{array}{ccc}
\frac{\partial f_1}{\partial x_1} & ... & \frac{\partial f_1}{\partial x_{m}} \\
... &...  &...  \\
\frac{\partial f_k}{\partial x_{1}} &...  & \frac{\partial f_k}{\partial x_{m}}\end{array} \right)$$
at $x$. Let $i_1,...,i_r$ be numbers of rows of that matrix which are linearly independent over $k(x)$. Next we define $Z$ as a closed subscheme of $\mathbb{A}^m_Y$ determined by the ideal generated by $f_{i_1},...,f_{i_r}$. In particular, $Z\ra Y$ is smooth at $x$. We also have the canonical closed immersion $u:X\hookrightarrow Z$. We show that $u^{\#}:\cO_{Z,x} \twoheadrightarrow \cO_{X,x} $ is an isomorphism. By assumption $X_{y}$ is smooth at $x$. Thus Proposition \ref{proposition:jacobian_criterion} implies that $u^{\#}\otimes_{\cO_{Y,y}}1_{k(y)}$ is an isomorphism. Since $\cO_{X,x}$ is flat $\cO_{Y,y}$-module, the exact sequence
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{0 & \Ker(u^{\#}) & \cO_{Z,x} & \cO_{X,x} & 0 \\} ;
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ u^{\#} $} (m-1-4)
(m-1-4) edge node[auto] {$ $} (m-1-5);
\end{tikzpicture}
\end{center}
remains exact after tensoring with $k(y)$ over $\cO_{Y,y}$. Thus $\Ker(u^{\#})\otimes_{\cO_{Y,y}}k(y) = 0$ which means that
$$\ideal{m}_y\cdot \Ker(u^{\#}) =\Ker(u^{\#})$$
Note that $\Ker(u^{\#})$ is generated by the germs of $f_j$ at $x$ for $j\neq i_1,...,i_r$. Hence $\Ker(u^{\#})$ is a finitely generated module over $\cO_{Z,x}$. Moreover, $\ideal{m}_y\cdot \cO_{Z,x}$ is contained in the Jacobson radical of $\cO_{Z,x}$. We infer by Nakayama lemma that $\Ker(u^{\#}) = 0$. Thus $u^{\#}$ is an isomorphism of $\cO_{Y,y}$-algebras. By Proposition \ref{proposition:jacobian_criterion} we derive that $f:X\ra Y$ is smooth at $x$.
\end{proof}

\section{Formal criterion for smoothness}
\noindent
Let $A$ be a commutative ring and let $A[[x_1,...,x_n]]$ be a ring of formal power series with coefficients in $A$. For every power series $f\in A[[x_1,...,x_n]]$ we denote by $f(o)$ its constant coefficient. The result below is a formal version of the inverse function theorem.

\begin{theorem}\label{theorem:formal_inverse_function_theorem}
Let $A$ be a ring and let $f_1,...,f_n \in A[[x_1,...,x_n]]$ be formal power series. Assume that
\begin{enumerate}[label=\emph{\textbf{(\arabic*)}}, leftmargin=3.0em]
\item $f_i(o)$ is zero for every $1\leq i\leq n$.
\item The determinant
$$\mathrm{det}\,\bigg[\frac{\partial f_i}{\partial x_j}(o)\bigg]_{1\leq i,j\leq n}$$
is invertible element of $A$.
\end{enumerate}
Then the morphism $A[[x_1,...,x_n]]\ra A[[x_1,...,x_n]]$ of $A$-algebras given by
$$x_i \mapsto f_i$$
for every $1\leq i \leq n$ is an isomorphism.
\end{theorem}
\begin{proof}
Denote by $g:A[[x_1,...,x_n]]\ra A[[x_1,...,x_n]]$ the morphism of $A$-algebras given by $g(x_i) = f_i$ for $1\leq i\leq n$. Let $I\subseteq A[[x_1,...,x_n]]$ be an ideal generated by $x_1,...,x_n$. Note that there is a canonical isomorphism
$$\mathrm{gr}_{I}(A[[x_1,...,x_n]]) \cong A[X_1,...,X_n]$$
Hence
$$\mathrm{gr}_{I}(g):\mathrm{gr}_{I}(A[[x_1,...,x_n]])\ra \mathrm{gr}_{I}(A[[x_1,...,x_n]])$$
is a graded endomorphism of a polynomial $A$-algebra $A[X_1,...,X_n]$ induced by an $A$-linear map given by
$$X_i \mapsto \sum^n_{i=1}\frac{\partial f_i}{\partial x_j}(o)X_j$$
for $1\leq i\leq n$. Since this $A$-linear map is induced by matrix
$$\left( \begin{array}{ccc}
\frac{\partial f_1}{\partial x_1}(o) & ... & \frac{\partial f_1}{\partial x_n}(o) \\
... &...  &...  \\
\frac{\partial f_n}{\partial x_1}(o) &...  & \frac{\partial f_n }{\partial x_n}(o)\end{array} \right)$$
which is invertible, we deduce that $\mathrm{gr}_{I}(g)$ is an isomorphism. There are commutative diagrams with exact rows
\begin{center}
\begin{tikzpicture}
[description/.style={fill=white,inner sep=2pt}]
\matrix (m) [matrix of math nodes, row sep=3em, column sep=2em,text height=1.5ex, text depth=0.25ex] 
{0 & I^{k-1}/I^k & A[[x_1,...,x_n]]/I^k & A[[x_1,...,x_n]]/I^{k-1} & 0 \\
 0 & I^{k-1}/I^k & A[[x_1,...,x_n]]/I^k & A[[x_1,...,x_n]]/I^{k-1} & 0 \\};
\path[->,line width=1.0pt,font=\scriptsize]  
(m-1-1) edge node[auto] {$  $} (m-1-2)
(m-1-2) edge node[auto] {$ $} (m-1-3)
(m-1-3) edge node[auto] {$ $} (m-1-4)
(m-1-4) edge node[auto] {$ $} (m-1-5)
(m-2-1) edge node[auto] {$  $} (m-2-2)
(m-2-2) edge node[auto] {$ $} (m-2-3)
(m-2-3) edge node[auto] {$ $} (m-2-4)
(m-2-4) edge node[auto] {$ $} (m-2-5)
(m-1-2) edge node[auto] {$ \mathrm{gr}_{I}(g)_{k-1}$} (m-2-2)
(m-1-3) edge node[auto] {$g_k $} (m-2-3)
(m-1-4) edge node[auto] {$g_{k-1} $} (m-2-4);
\end{tikzpicture}
\end{center}
in which $g_k$ and $g_{k-1}$ are induced by $g$ for $k\geq 2$. Moreover, observe that $g_1:A\ra A$ is an isomorphism as $g$ is morphism of $A$-algebras. Thus the fact that $g$ is an isomorphism follows by induction on $k$ and the equality $g = \lim_{k\in \NN}g_k$.
\end{proof}

\begin{theorem}\label{theorem:formal_criterion_for_smoothness}
Let $f:X\ra Y$ be a morphism and $x\in X$ be a point. Consider the following statements.
\begin{enumerate}[label=\emph{\textbf{(\roman*)}}, leftmargin=3.0em]
\item $f$ induces an isomorphism $k(x)\cong k(f(x))$ and it is smooth of relative dimension $n$ at $x$.
\item The morphism $f^{\#}:\cO_{Y,f(x)}\ra \cO_{X,x}$ induces an isomorphism of algebras
$$\widehat{\cO_{X,x}}\cong \widehat{\cO_{Y,f(x)}}[[x_1,...,x_n]]$$
\end{enumerate}
Then $\textbf{\emph{(i)}}\Rightarrow \textbf{\emph{(ii)}}$. If there exists a neighborhood $U$ of $x$ such that $f_{\mid U}$ is locally of finite type and $Y$ is locally noetherian, then also $\textbf{\emph{(ii)}}\Rightarrow \textbf{\emph{(i)}}$.
\end{theorem}
\begin{proof}
Suppose that $f$ is smooth of relative dimension $n$ at $x$ and induces an isomorphism $k(x)\cong k(f(x))$. By taking base change to $\Spec \cO_{Y,f(x)}$ we are reduced to the statement over a local ring $(A,\ideal{m})$. Suppose that $\ideal{q}$ is a prime ideal in the polynomial ring $A[x_1,...,x_{n+r}]$ and there are polynomials $f_1$,...,$f_r$ such that the Jacobian matrix
$$\left( \begin{array}{ccc}
\frac{\partial f_1}{\partial x_1} & ... & \frac{\partial f_1}{\partial x_{n+r}} \\
... &...  &...  \\
\frac{\partial f_r}{\partial x_{1}} &...  & \frac{\partial f_r}{\partial x_{n+r}}\end{array} \right)$$
has rank $r$ at point $\ideal{q}$. Moreover, assume that $\ideal{m} = \ideal{q} \cap A$ and the canonical morphism $k(\ideal{m})\ra k(\ideal{q})$ is an isomorphism. Then $\ideal{q}$ is maximal ideal and that there exist $a_1$,...,$a_{n+r}\in A$ such that
$$(x_1-a_1),...,(x_{n+r}-a_{n+r})\in \ideal{q}$$
We derive that $\ideal{q}=\ideal{m}[x_1,...,x_{n+r}]+(x_1-a_1,...,x_{n+r}-a_{n+r})$. Now by $A$-linear change of variables we may assume that $a_1 = ... = a_{n+r} = 0$. Thus $\ideal{q} = \ideal{m}[x_1,...,x_{n+r}]+(x_1,...,x_{n+r})$. Since completion is right exact we deduce that the completion of $A[x_1,...,x_{n+r}]_{\ideal{q}}/(f_1,...,f_r)_{\ideal{q}}$ in $\ideal{q}$-adic topology is isomorphic with
$$\widehat{A}[[x_1,...,x_{n+r}]]/(f_1,...,f_r)$$
as $\widehat{A}$-algebra. Here $\widehat{A}$ is the completion of $A$ with respect to $\ideal{m}$-adic topology. Consider now the continuous morphism $g:\widehat{A}[[x_1,...,x_{n+r}]] \ra \widehat{A}[[x_1,...,x_{n+r}]]$ of $\widehat{A}$-algebras given by
$$g(x_i)=\begin{cases} 
f_i &\mbox{if } 1\leq i\leq r\\
x_{j_i} &\mbox{if } r+1\leq i\leq n+r
\end{cases}$$
where $x_{j_{r+1}}$,...,$x_{j_{n+r}}$ are chosen in such a way that the matrix
$$\left( \begin{array}{ccc}
\frac{\partial g(x_1)}{\partial x_1} & ... & \frac{\partial g(x_1)}{\partial x_{n+r}} \\
... &...  &...  \\
\frac{\partial g(x_{n+r})}{\partial x_1} &...  & \frac{\partial g(x_{n+r})}{\partial x_{n+r}}\end{array} \right)$$
is invertible at a unique maximal ideal of $\widehat{A}[[x_1,...,x_{n+r}]]$. Hence this matrix is invertible also modulo $(x_1...,x_{n+r})$. Now using Theorem \ref{theorem:formal_inverse_function_theorem} we deduce that $g$ is an isomorphism of $\widehat{A}$-algebras. Therefore, we have following isomorphisms of $\widehat{A}$-algebras
$$\widehat{A}[[x_{1},...x_{n}]]\cong \widehat{A}[[x_1,...,x_{n+r}]]/(x_1,...,x_r)\cong \widehat{A}[[x_1,...,x_{n+r}]]/(f_1,...,f_r)$$
This shows that $\textbf{(i)}\Rightarrow \textbf{(ii)}$.\\
Suppose now that there exists a neighbourhood $U$ of $x$ such that $f_{\mid U}$ is locally of finite type and $Y$ is locally noetherian. Assume that \textbf{(ii)} holds. Clearly $f$ induces an isomorphism $k(x)\cong k(f(x))$. Next formation of formal power series with noetherian coefficient ring is flat. Thus we deduce that $\widehat{\cO_{X,x}}\cong \widehat{\cO_{Y,f(x)}}[[x_1,...,x_n]]$ is flat over $\widehat{\cO_{Y,f(x)}}$. Since $\widehat{\cO_{Y,f(x)}}$ is flat over $\cO_{Y,f(x)}$, we infer that $\widehat{\cO_{X,x}}$ is flat $\cO_{Y,f(x)}$-algebra. Finally since $\widehat{\cO_{X,x}}$ is faithfuly flat over $\cO_{X,x}$, we derive that $\cO_{X,x}$ is flat $\cO_{Y,f(x)}$-algebra. Hence $f$ is flat at $x$. Let $X_{f(x)}$ be the fiber of $f$ over $f(x)$. Since $k((f(x))\ra k(x)$ is separable algebraic, the conormal sequence for inclusion of the closed point into $\Spec \cO_{X_{f(x)},x}$ is exact and yields an isomorphism
$$\ideal{m}_{X_{f(x)},x}/\ideal{m}_{X_{f(x)},x}^2\cong k(x)\otimes_{\cO_{X_{f(x)},x}}\Omega_{\cO_{X_{f(x)},x}/k(f(x))}$$
One can easily check that $\widehat{\cO_{X,f(x)}}\cong k(f(x))[[x_1,...,x_n]]$ is a formal power series $k(f(x))$-algebra. Thus $\cO_{X_{f(x)},x}$ is a regular local ring of dimension $n$. This shows that
$$\mathrm{dim}_x\big(X_{f(x)}\big)=n=\mathrm{dim}_{k(x)}(k(x)\otimes_{\cO_{X_{f(x)},x}}\Omega_{\cO_{X_{f(x)},x}/k(f(x))})$$
By Theorem \ref{theorem:main_result_concerning_smoothness_over_a_field}  scheme $X_{f(x)}$ is smooth of relative dimension $n$ at $x$. We showed that $f$ is flat at $x$ and that $X_{f(x)}$ is smooth of relative dimension $n$ at $x$. Since $Y$ is locally noetherian, the restriction $f_{\mid U}$ is locally of finite presentation. Hence $f$ is smooth of relative dimension $n$ by Theorem \ref{theorem:smooth_is_flat_with_smooth_fibers}. This shows that $\textbf{(ii)}\Rightarrow \textbf{(i)}$ holds under additional assumptions described in the statement.
\end{proof}


\small
\bibliographystyle{apalike}
\bibliography{../zzz}

\end{document}